{% extends "base.html" %}
{% set title = "Stores" %}
{% block content %}

<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
  <h2 style="margin:0;">Stores</h2>
  <a class="btn" href="/admin/import">Bulk Import</a>
</div>

<div class="card">
  <h3 style="margin-top:0;">Add Store</h3>

  <form method="post">
    <input type="hidden" name="action" value="create"/>

    <div style="display:grid; grid-template-columns: 2fr 1.4fr 1fr 1fr .7fr auto; gap:10px; align-items:end;">
      <div>
        <label style="display:block; font-size:12px; margin-bottom:6px;">Store name</label>
        <input name="name" placeholder="Store name" required>
      </div>

      <div>
        <label style="display:block; font-size:12px; margin-bottom:6px;">Store code (unique)</label>
        <input name="qr_token" placeholder="ex: reasors_s_ba" required>
      </div>

      <div>
        <label style="display:block; font-size:12px; margin-bottom:6px;">Latitude</label>
        <input name="latitude" placeholder="36.123456" required>
      </div>

      <div>
        <label style="display:block; font-size:12px; margin-bottom:6px;">Longitude</label>
        <input name="longitude" placeholder="-95.123456" required>
      </div>

      <div>
        <label style="display:block; font-size:12px; margin-bottom:6px;">Radius (m)</label>
        <input name="geofence_radius_m" placeholder="150" value="150">
      </div>

      <div>
        <button class="btn btn-primary" type="submit">Create</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px; font-size: 13px;">
      Radius is meters (typical: 150â€“250m). Store code is case-insensitive.
    </div>
  </form>
</div>

<div class="card">
  <h3 style="margin-top:0;">Store List</h3>
  <div class="muted" style="margin-bottom:10px; font-size: 13px;">
    Edit inline and click <strong>Save</strong>. Delete is blocked if the store has shift history.
  </div>

  <div style="overflow:auto;">
    <table>
      <thead>
        <tr>
          <th style="min-width: 220px;">Name</th>
          <th style="min-width: 170px;">Code</th>
          <th style="min-width: 140px;">Latitude</th>
          <th style="min-width: 140px;">Longitude</th>
          <th style="min-width: 110px;">Radius</th>
          <th class="right" style="min-width: 170px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for s in stores %}
        <tr>
          <td colspan="6" style="padding:0;">
            <form method="post" action="/admin/stores/update" style="display:grid; grid-template-columns: 220px 170px 140px 140px 110px 1fr; gap:10px; padding:10px; align-items:center;">
              <input type="hidden" name="store_id" value="{{ s.id }}"/>

              <div>
                <input name="name" value="{{ s.name }}" required>
              </div>

              <div>
                <input name="qr_token" value="{{ s.qr_token }}" required>
              </div>

              <div>
                <input name="latitude" value="{{ "%.8f"|format(s.latitude) }}" required>
              </div>

              <div>
                <input name="longitude" value="{{ "%.8f"|format(s.longitude) }}" required>
              </div>

              <div>
                <input name="geofence_radius_m" value="{{ s.geofence_radius_m }}" required>
              </div>

              <div class="right" style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-primary" type="submit">Save</button>
            </form>

                <form method="post" action="/admin/stores/delete" style="display:inline;">
                  <input type="hidden" name="store_id" value="{{ s.id }}"/>
                  <button
                    class="btn btn-danger"
                    type="submit"
                    onclick="return confirm('Delete store: {{ s.name }}? This is blocked if the store has any shift history.')"
                  >
                    Delete
                  </button>
                </form>
              </div>
          </td>
        </tr>
        {% endfor %}

        {% if stores|length == 0 %}
          <tr><td colspan="6" class="muted">No stores yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
