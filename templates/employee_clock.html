<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Employee Time Clock</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f6f7fb; }
    .brand-card { border: 0; border-radius: 18px; }
    .brand-logo { max-height: 56px; width: auto; }
    .big-btn { padding: 14px 16px; font-size: 1.15rem; border-radius: 14px; }
    .muted { color: #6c757d; }
    .status-box { border-radius: 14px; }
    .tiny { font-size: .9rem; }
    code { font-size: .95em; }
  </style>
</head>
<body>
  <div class="container py-4" style="max-width: 520px;">
    <div class="card shadow-sm brand-card">
      <div class="card-body p-4">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <img class="brand-logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Company Logo">
          <span class="badge text-bg-dark">Time Clock</span>
        </div>

        <h2 class="mb-1">Employee Time Clock</h2>
        <div class="muted mb-3">Enter your PIN and Store Code.</div>

        <div class="mb-3">
          <label class="form-label">PIN</label>
          <input id="pin" class="form-control form-control-lg" inputmode="numeric" placeholder="Enter your PIN" />
        </div>

        <div class="mb-2">
          <label class="form-label">Store Code</label>
          <input
            id="store_code"
            class="form-control form-control-lg"
            placeholder="Start typing store name or codeâ€¦"
            list="storeList"
            autocomplete="off"
          />
          <datalist id="storeList">
            {% for s in stores %}
              <option value="{{ s.code }}">{{ s.name }}</option>
            {% endfor %}
          </datalist>
          <div id="storeName" class="tiny muted mt-1"></div>
        </div>

        <!-- Banner shown only when clocked in -->
        <div id="clockedInBanner" class="alert alert-warning status-box mt-3 mb-0 tiny d-none" role="alert">
          <strong>You are CLOCKED IN.</strong> Please clock out before leaving or closing this page.
        </div>

        <div class="d-grid gap-2 mt-3">
          <button id="btnClockIn" class="btn btn-dark big-btn" onclick="doClockIn()">Clock In</button>
          <button id="btnClockOut" class="btn btn-outline-dark big-btn" onclick="doClockOut()">Clock Out</button>
        </div>

        <div id="status" class="alert alert-light status-box mt-3 mb-0 tiny" role="alert">
          Ready.
        </div>

      </div>
    </div>

    <div class="text-center muted tiny mt-3">
      Tip: This phone will remember your last Store Code automatically.
    </div>
  </div>

<script>
  const STORES = {{ stores|tojson }};

  // Track whether this device is currently clocked in (for leave warning + button states)
  let IS_CLOCKED_IN = (localStorage.getItem("is_clocked_in") === "true");

  function setStatus(msg, kind="light") {
    const el = document.getElementById("status");
    el.className = `alert alert-${kind} status-box mt-3 mb-0 tiny`;
    el.textContent = msg;
  }

  function updateButtonsAndBanner() {
    const banner = document.getElementById("clockedInBanner");
    const btnIn = document.getElementById("btnClockIn");
    const btnOut = document.getElementById("btnClockOut");

    if (IS_CLOCKED_IN) {
      banner.classList.remove("d-none");
      btnIn.disabled = true;
      btnOut.disabled = false;
    } else {
      banner.classList.add("d-none");
      btnIn.disabled = false;
      btnOut.disabled = true;
    }
  }

  function setClockedIn(flag) {
    IS_CLOCKED_IN = !!flag;
    localStorage.setItem("is_clocked_in", IS_CLOCKED_IN ? "true" : "false");
    updateButtonsAndBanner();
  }

  // Warn user if they try to leave while clocked in
  window.addEventListener("beforeunload", (e) => {
    if (!IS_CLOCKED_IN) return;
    // Most browsers show a generic message (custom text is ignored)
    e.preventDefault();
    e.returnValue = "";
  });

  function updateStoreName() {
    const code = (document.getElementById("store_code").value || "").trim();
    const match = STORES.find(s => s.code === code);
    document.getElementById("storeName").textContent = match ? `Selected: ${match.name}` : "";
  }

  // Remember last store code on this device
  window.addEventListener("load", () => {
    const saved = localStorage.getItem("last_store_code");
    if (saved) document.getElementById("store_code").value = saved;

    updateStoreName();
    updateButtonsAndBanner();

    if (IS_CLOCKED_IN) {
      setStatus("You appear to be CLOCKED IN on this device. Clock out before leaving this page.", "warning");
    }
  });

  document.getElementById("store_code").addEventListener("input", () => {
    updateStoreName();
    const code = (document.getElementById("store_code").value || "").trim();
    if (code) localStorage.setItem("last_store_code", code);
  });

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("Geolocation not supported."));
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        err => reject(err),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  async function doClockIn() {
    if (IS_CLOCKED_IN) return; // safety

    const pin = (document.getElementById("pin").value || "").trim();
    const qr_token = (document.getElementById("store_code").value || "").trim();

    if (!pin) return setStatus("Enter your PIN.", "warning");
    if (!qr_token) return setStatus("Enter your Store Code.", "warning");

    // Prevent double taps
    document.getElementById("btnClockIn").disabled = true;

    setStatus("Getting location...");
    let loc;
    try { loc = await getLocation(); }
    catch(e) {
      document.getElementById("btnClockIn").disabled = false;
      return setStatus("Location failed. Turn on location services and try again.", "danger");
    }

    setStatus("Clocking in...");
    const res = await fetch("/api/clockin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin, qr_token, lat: loc.lat, lng: loc.lng })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      document.getElementById("btnClockIn").disabled = false;
      return setStatus(data.error || "Clock-in failed.", "danger");
    }

    setStatus(data.message || "Clock-in successful.", "success");
    setClockedIn(true);
  }

  async function doClockOut() {
    if (!IS_CLOCKED_IN) return; // safety

    const pin = (document.getElementById("pin").value || "").trim();
    const qr_token = (document.getElementById("store_code").value || "").trim();

    if (!pin) return setStatus("Enter your PIN.", "warning");
    if (!qr_token) return setStatus("Enter your Store Code.", "warning");

    // Prevent double taps
    document.getElementById("btnClockOut").disabled = true;

    setStatus("Getting location...");
    let loc;
    try { loc = await getLocation(); }
    catch(e) {
      document.getElementById("btnClockOut").disabled = false;
      return setStatus("Location failed. Turn on location services and try again.", "danger");
    }

    setStatus("Clocking out...");
    const res = await fetch("/api/clockout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin, qr_token, lat: loc.lat, lng: loc.lng })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      document.getElementById("btnClockOut").disabled = false;
      return setStatus(data.error || "Clock-out failed.", "danger");
    }

    const hours = (data.hours !== undefined) ? ` Hours: ${data.hours}` : "";
    setStatus((data.message || "Clock-out successful.") + hours, "success");
    setClockedIn(false);
  }
</script>
</body>
</html>
