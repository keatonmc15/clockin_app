<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Employee Time Clock</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f6f7fb; }
    .brand-card { border: 0; border-radius: 18px; }
    .brand-logo { max-height: 56px; width: auto; }
    .big-btn { padding: 14px 16px; font-size: 1.15rem; border-radius: 14px; }
    .muted { color: #6c757d; }
    .status-box { border-radius: 14px; }
    .tiny { font-size: .9rem; }
    code { font-size: .95em; }
  </style>
</head>
<body>
  <div class="container py-4" style="max-width: 520px;">
    <div class="card shadow-sm brand-card">
      <div class="card-body p-4">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <img class="brand-logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Company Logo">
          <span class="badge text-bg-dark">Time Clock</span>
        </div>

        <h2 class="mb-1">Employee Time Clock</h2>
        <div class="muted mb-3">Enter your PIN and Store Code.</div>

        <!-- CLOCKED-IN BANNER -->
        <div id="clockedBanner" class="alert alert-success status-box tiny d-none" role="alert">
          <div class="fw-semibold">CLOCKED IN: <span id="clockedName">Employee</span></div>
          <div class="tiny">Come back here to clock out when your shift ends.</div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="pin">PIN</label>
          <input id="pin" class="form-control form-control-lg" inputmode="numeric" placeholder="Enter your PIN" />
        </div>

        <div class="mb-2">
          <label class="form-label" for="store_code">Store Code</label>
          <input
            id="store_code"
            class="form-control form-control-lg"
            placeholder="Start typing store name or code…"
            list="storeList"
            autocomplete="off"
            autocapitalize="characters"
            spellcheck="false"
          />
          <datalist id="storeList">
            {% for s in stores %}
              <option value="{{ s.code }}">{{ s.name }}</option>
            {% endfor %}
          </datalist>
          <div id="storeName" class="tiny muted mt-1"></div>
        </div>

        <div class="d-grid gap-2 mt-3">
          <button id="btnClockIn" class="btn btn-dark big-btn" onclick="doClockIn()">Clock In</button>
          <button id="btnClockOut" class="btn btn-outline-dark big-btn" onclick="doClockOut()">Clock Out</button>
        </div>

        <div id="status" class="alert alert-light status-box mt-3 mb-0 tiny" role="alert">
          Ready.
        </div>

        <!-- GPS DEBUG LINE (employee-friendly + helps you troubleshoot) -->
        <div class="mt-2 tiny muted">
          <div><span class="fw-semibold">GPS:</span> <span id="gpsPerm">—</span></div>
          <div>
            <span class="fw-semibold">Accuracy:</span>
            <span id="gpsAcc">—</span>
            <span id="gpsTime" class="ms-2"></span>
          </div>
        </div>

      </div>
    </div>

    <div class="text-center muted tiny mt-3">
      Tip: This phone will remember your last Store Code automatically.
    </div>
  </div>

<script>
  const STORES = {{ stores|tojson }};

  // ---- Local state keys ----
  const LS_CLOCKED_IN = "clocked_in";
  const LS_CLOCKED_NAME = "clocked_in_name";
  const LS_CLOCKED_SHIFT_ID = "clocked_in_shift_id";
  const LS_LAST_STORE = "last_store_code";

  let BUSY = false;

  function isClockedIn() {
    return localStorage.getItem(LS_CLOCKED_IN) === "1";
  }

  function setClockedIn(on, payload = {}) {
    if (on) {
      localStorage.setItem(LS_CLOCKED_IN, "1");
      if (payload.name) localStorage.setItem(LS_CLOCKED_NAME, payload.name);
      if (payload.shift_id !== undefined && payload.shift_id !== null) {
        localStorage.setItem(LS_CLOCKED_SHIFT_ID, String(payload.shift_id));
      }
    } else {
      localStorage.removeItem(LS_CLOCKED_IN);
      localStorage.removeItem(LS_CLOCKED_NAME);
      localStorage.removeItem(LS_CLOCKED_SHIFT_ID);
    }
    updateUI();
  }

  function setStatus(msg, kind="light") {
    const el = document.getElementById("status");
    el.className = `alert alert-${kind} status-box mt-3 mb-0 tiny`;
    el.textContent = msg;
  }

  // ---- GPS debug helpers ----
  function setGpsInfo({ permText="—", accuracyM=null, ts=null } = {}) {
    const permEl = document.getElementById("gpsPerm");
    const accEl = document.getElementById("gpsAcc");
    const timeEl = document.getElementById("gpsTime");

    permEl.textContent = permText;

    if (accuracyM === null || accuracyM === undefined) {
      accEl.textContent = "—";
    } else {
      accEl.textContent = `±${Math.round(accuracyM)} m`;
    }

    if (!ts) {
      timeEl.textContent = "";
    } else {
      const d = new Date(ts);
      timeEl.textContent = `(${d.toLocaleTimeString()})`;
    }
  }

  async function refreshGpsPermission() {
    if (!navigator.geolocation) {
      setGpsInfo({ permText: "Not supported" });
      return;
    }

    // Some browsers don’t support Permissions API reliably; handle gracefully.
    if (!("permissions" in navigator) || !navigator.permissions.query) {
      setGpsInfo({ permText: "Unknown" });
      return;
    }

    try {
      const perm = await navigator.permissions.query({ name: "geolocation" });
      const label =
        perm.state === "granted" ? "Allowed" :
        perm.state === "denied"  ? "Denied" :
        "Needs approval";

      setGpsInfo({ permText: label });

      // Update if user changes permission while page is open
      perm.onchange = () => refreshGpsPermission();
    } catch (e) {
      setGpsInfo({ permText: "Unknown" });
    }
  }

  function updateGpsFromPosition(pos) {
    setGpsInfo({
      permText: "Allowed",
      accuracyM: pos?.coords?.accuracy ?? null,
      ts: pos?.timestamp ?? Date.now()
    });
  }

  function normalizeStoreInput() {
    const el = document.getElementById("store_code");
    const raw = (el.value || "");
    const norm = raw.trim().toUpperCase();
    if (el.value !== norm) el.value = norm;
    return norm;
  }

  function updateStoreName() {
    const code = normalizeStoreInput();
    const match = STORES.find(s => String(s.code).toUpperCase() === code);
    document.getElementById("storeName").textContent = match ? `Selected: ${match.name}` : "";
  }

  function setBusy(on, which="") {
    BUSY = on;
    const btnIn = document.getElementById("btnClockIn");
    const btnOut = document.getElementById("btnClockOut");

    btnIn.disabled = on || isClockedIn();
    btnOut.disabled = on || !isClockedIn();

    if (on) {
      if (which === "in") btnIn.textContent = "Clocking in…";
      if (which === "out") btnOut.textContent = "Clocking out…";
    } else {
      btnIn.textContent = "Clock In";
      btnOut.textContent = "Clock Out";
    }
  }

  function updateUI() {
    const banner = document.getElementById("clockedBanner");
    const clockedNameEl = document.getElementById("clockedName");

    const pinInput = document.getElementById("pin");
    const storeInput = document.getElementById("store_code");
    const btnIn = document.getElementById("btnClockIn");
    const btnOut = document.getElementById("btnClockOut");

    const clocked = isClockedIn();
    const name = localStorage.getItem(LS_CLOCKED_NAME) || "Employee";

    // Banner
    if (clocked) {
      banner.classList.remove("d-none");
      clockedNameEl.textContent = name;
    } else {
      banner.classList.add("d-none");
    }

    // Lock inputs when clocked in (and during busy)
    pinInput.disabled = clocked || BUSY;
    storeInput.disabled = clocked || BUSY;

    // Buttons
    btnIn.disabled = BUSY || clocked;
    btnOut.disabled = BUSY || !clocked;

    // Warn when leaving while clocked in
    window.__shouldWarnOnLeave = clocked;
  }

  // Remember last store code on this device + init UI
  window.addEventListener("load", () => {
    const saved = localStorage.getItem(LS_LAST_STORE);
    if (saved) document.getElementById("store_code").value = saved;

    updateStoreName();
    updateUI();

    // GPS permission line
    refreshGpsPermission();

    // Optional: warm up a GPS fix so accuracy shows even before punching
    // (If permission is denied or prompt, it will just fail silently)
    getLocation().catch(() => {});
  });

  document.getElementById("store_code").addEventListener("input", () => {
    updateStoreName();
    const code = normalizeStoreInput();
    if (code) localStorage.setItem(LS_LAST_STORE, code);
  });

  // Browser "Are you sure you want to leave?" popup while clocked in
  window.addEventListener("beforeunload", (e) => {
    if (!window.__shouldWarnOnLeave) return;
    e.preventDefault();
    e.returnValue = "";
  });

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        setGpsInfo({ permText: "Not supported" });
        return reject(new Error("Geolocation not supported."));
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          updateGpsFromPosition(pos);
          resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy });
        },
        err => {
          // Map common errors to the GPS line
          if (err && err.code === 1) setGpsInfo({ permText: "Denied" });           // PERMISSION_DENIED
          else if (err && err.code === 2) setGpsInfo({ permText: "Unavailable" }); // POSITION_UNAVAILABLE
          else if (err && err.code === 3) setGpsInfo({ permText: "Timeout" });     // TIMEOUT
          else setGpsInfo({ permText: "Error" });

          reject(err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  async function doClockIn() {
    if (BUSY) return;
    if (isClockedIn()) return setStatus("You are already clocked in.", "warning");

    const pin = (document.getElementById("pin").value || "").trim();
    const qr_token = normalizeStoreInput();

    if (!pin) return setStatus("Enter your PIN.", "warning");
    if (!qr_token) return setStatus("Enter your Store Code.", "warning");

    setBusy(true, "in");
    setStatus("Getting location...");

    let loc;
    try { loc = await getLocation(); }
    catch(e) {
      setBusy(false);
      return setStatus("Location failed. Turn on location services and try again.", "danger");
    }

    setStatus("Clocking in...");
    const res = await fetch("/api/clockin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin, qr_token, lat: loc.lat, lng: loc.lng })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setBusy(false);
      return setStatus(data.error || "Clock-in failed.", "danger");
    }

    setClockedIn(true, { name: data.employee || "", shift_id: data.shift_id });
    setStatus(data.message || "Clock-in successful.", "success");
    setBusy(false);
  }

  async function doClockOut() {
    if (BUSY) return;

    const pin = (document.getElementById("pin").value || "").trim();
    const qr_token = normalizeStoreInput();

    if (!pin) return setStatus("Enter your PIN.", "warning");
    if (!qr_token) return setStatus("Enter your Store Code.", "warning");

    setBusy(true, "out");
    setStatus("Getting location...");

    let loc;
    try { loc = await getLocation(); }
    catch(e) {
      setBusy(false);
      return setStatus("Location failed. Turn on location services and try again.", "danger");
    }

    setStatus("Clocking out...");
    const res = await fetch("/api/clockout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin, qr_token, lat: loc.lat, lng: loc.lng })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      const msg = (data.error || "Clock-out failed.").toLowerCase();
      if (msg.includes("no open shift")) {
        setClockedIn(false);
        setStatus("No open shift found. It may have been closed by an admin.", "warning");
        setBusy(false);
        return;
      }
      setBusy(false);
      return setStatus(data.error || "Clock-out failed.", "danger");
    }

    setClockedIn(false);

    const hours = (data.hours !== undefined) ? ` Hours: ${data.hours}` : "";
    setStatus((data.message || "Clock-out successful.") + hours, "success");
    setBusy(false);
  }
</script>
</body>
</html>
